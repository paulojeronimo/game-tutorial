<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Paulo Jerônimo, 2022-07-26">
<title>Game Tutorial</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Game Tutorial</h1>
<div class="details">
<span id="author" class="author">Paulo Jerônimo, 2022-07-26</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Game Tutorial</div>
<ul class="sectlevel1">
<li><a href="#softwarerequirements">1. Software requirements</a></li>
<li><a href="#creatingtheproject">2. Creating the project</a></li>
<li><a href="#addingjestandsupertest">3. Adding Jest and SuperTest</a></li>
<li><a href="#creatingabasicapitest">4. Creating a basic API test</a></li>
<li><a href="#improvingtheapitest">5. Improving the API test</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="softwarerequirements"><a class="anchor" href="#softwarerequirements"></a>1. Software requirements</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://nodejs.org">Node.js</a> installed.</p>
</li>
<li>
<p><a href="https://httpie.io/">httpie</a> installed.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This tutorial was only tested on Ubuntu 22.04.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creatingtheproject"><a class="anchor" href="#creatingtheproject"></a>2. Creating the project</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ mkdir -p game &amp;&amp; cd $_

$ npm init -y

$ npm install express

$ cat &gt; index.js &lt;&lt;'EOF'
const express = require('express')
const app = express()

const result = {
  "rounds": 1000,
  "playersBalances": [
    { "cautious": 100 },
    { "random": 80 },
    { "demanding": 40 },
    { "impulsive": 30 }
  ]
}

app.get('/', (req, res) =&gt; {
  res.setHeader('Content-Type', 'application/json')
  res.end(JSON.stringify(result))
})

app.listen(8080)
EOF

$ node index.js &amp;&gt; game.log &amp;

$ http localhost:8080

$ kill %1</pre>
</div>
</div>
<div class="paragraph">
<p>Initial commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git init

$ cat &gt; .gitignore &lt;&lt;'EOF'
/node_modules
*.log
EOF

$ git add .
$ git status
$ git commit -m 'Initial commit'</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="addingjestandsupertest"><a class="anchor" href="#addingjestandsupertest"></a>3. Adding Jest and SuperTest</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ npm install -D jest supertest</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git apply &lt;&lt;'EOF'
diff --git a/package.json b/package.json
index e7a65a7..e6c60fd 100644
--- a/package.json
+++ b/package.json
@@ -4,7 +4,7 @@
   "description": "",
   "main": "index.js",
   "scripts": {
-    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
+    "test": "jest"
   },
   "keywords": [],
   "author": "",
@@ -15,5 +15,11 @@
   "devDependencies": {
     "jest": "^28.1.3",
     "supertest": "^6.2.4"
+  },
+  "jest": {
+    "testEnvironment": "node",
+    "coveragePathIgnorePatterns": [
+      "/node_modules"
+    ]
   }
 }
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm test

&gt; game@1.0.0 test
&gt; jest

No tests found, exiting with code 1
Run with `--passWithNoTests` to exit with code 0
In /home/pj/Downloads/desabio-bp/game
  3 files checked.
  testMatch: **/__tests__/**/*.[jt]s?(x), **/?(*.)+(spec|test).[tj]s?(x) - 0 matches
  testPathIgnorePatterns: /node_modules/ - 3 matches
  testRegex:  - 0 matches
Pattern:  - 0 matches</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cat &gt; sample.test.js &lt;&lt;'EOF'
describe('Sample Test', () =&gt; {
  it('should test tha true === true', () =&gt; {
    expect(true).toBe(true)
  })
})
EOF

$ npm test</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git add .
$ git status
$ git commit -m 'Added configuration for Jest and SuperTest'</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creatingabasicapitest"><a class="anchor" href="#creatingabasicapitest"></a>4. Creating a basic API test</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, a little refactoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git apply &lt;&lt;'EOF'
diff --git a/index.js b/index.js
index c1a3811..f6682c5 100644
--- a/index.js
+++ b/index.js
@@ -16,4 +16,4 @@ app.get('/', (req, res) =&gt; {
   res.end(JSON.stringify(result))
 })

-app.listen(8080)
+module.exports = app
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cat &gt; app.js &lt;&lt;'EOF'
const app = require('./index')

app.listen(8080)
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ node app.js &amp;&gt; game.log &amp;

$ http localhost:8080

$ kill %1</pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s create a basic test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cat &gt; index.test.js &lt;&lt;'EOF'
const supertest = require('supertest')
const app = require('./index')

test('GET /', async () =&gt; {
  const response = await supertest(app).get('/')

  expect(response.statusCode).toEqual(200)
  expect(response.body.rounds).toEqual(1000)
})
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>Do our test again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm test

&gt; game@1.0.0 test
&gt; jest

 PASS  ./index.test.js
 PASS  ./sample.test.js

Test Suites: 2 passed, 2 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        0.429 s, estimated 1 s
Ran all test suites.</pre>
</div>
</div>
<div class="paragraph">
<p>Remove <code>sample.test.js</code> (we don&#8217;t need it anymore):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rm sample.test.js</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit our basic test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git add .
$ git status
$ git commit -m 'Added a first SuperTest'</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="improvingtheapitest"><a class="anchor" href="#improvingtheapitest"></a>5. Improving the API test</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$ git apply &lt;&lt;'EOF'
diff --git a/index.test.js b/index.test.js
index 8498451..a9f5cbf 100644
--- a/index.test.js
+++ b/index.test.js
@@ -1,9 +1,12 @@
 const supertest = require('supertest')
 const app = require('./index')

-test('GET /', async () =&gt; {
-  const response = await supertest(app).get('/')
-
-  expect(response.statusCode).toEqual(200)
-  expect(response.body.rounds).toEqual(1000)
+describe('GET /', () =&gt; {
+  it('responds with json', (done) =&gt; {
+    supertest(app)
+      .get('/')
+      .set('Accept', 'application/json')
+      .expect('Content-Type', /json/)
+      .expect(200, done)
+  })
 })
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm test
$ git add .</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git apply &lt;&lt;'EOF'
diff --git a/index.test.js b/index.test.js
index a9f5cbf..385822e 100644
--- a/index.test.js
+++ b/index.test.js
@@ -1,12 +1,28 @@
 const supertest = require('supertest')
 const app = require('./index')

+const isSorted = (arr) =&gt;
+  !!arr.reduce((n, item) =&gt; n !== false &amp;&amp; item &gt;= n &amp;&amp; item)
+
 describe('GET /', () =&gt; {
-  it('responds with json', (done) =&gt; {
-    supertest(app)
+  it('responds with a valid json', async () =&gt; {
+    const response = await supertest(app)
       .get('/')
       .set('Accept', 'application/json')
-      .expect('Content-Type', /json/)
-      .expect(200, done)
+    expect(response.headers['content-type']).toMatch(/json/)
+    expect(response.status).toEqual(200)
+
+    // check if the number of rounds was defined and it is numeric
+    expect(typeof response.body.rounds).toBe('number')
+
+    const playersBalances = response.body.playersBalances
+
+    // check if we have four players
+    expect(playersBalances).toBeDefined()
+    expect(playersBalances.length).toBe(4)
+
+    // create an array with balances and check if it is Sorted
+    const balances = playersBalances.map(o =&gt; Object.values(o)[0]).reverse()
+    expect(isSorted(balances)).toBe(true)
   })
 })
EOF</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ npm test</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git add .
$ git commit 'Improved the API test'</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>